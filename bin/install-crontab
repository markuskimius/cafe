#!/bin/bash

##############################################################################
# COFFEE: Buzz up your UNIX login
# https://github.com/markuskimius/coffee
#
# Copyright (c)2020 Mark K. Kim
# Released under the Apache license 2.0
# https://github.com/markuskimius/coffee/blob/master/LICENSE
##############################################################################

function usage() {
    cat <<EOF
Install \$COFFEE/*/etc/crontab as the current user's crontab.

Usage: ${SCRIPTNAME} [-v]

  -v,--verbose          Verbose mode.

EOF
}


##############################################################################
# PROGRAM BEGINS HERE

include "getopt.sh"

SCRIPTNAME=$(basename "${BASH_SOURCE}")
VERBOSE=0


function main() {
    local OPTOPT OPTARG OPTERR OPTARRAY
    local errcount=0

    # Process options
    while coffee::getopt "hv" "help,verbose" "$@"; do
        case "$OPTOPT" in
            -h|--help)     usage && exit 0          ;;
            -v|--verbose)  VERBOSE=1                ;;
            *)             errcount=$((errcount+1)) ;;
        esac
    done

    # Sanity check
    if (( errcount )); then
        echo "Type '${SCRIPTNAME} -h' for help." 1>&2
        exit 1
    fi

    install_crontab "${OPTARRAY[@]}"
}


function install_crontab() {
    local crontabs=()
    local file

    (( VERBOSE )) && header "CURRENT CRONTAB"
    (( VERBOSE )) && crontab -l

    (( VERBOSE )) && header "INSTALLING NEW CRONTAB"
    for file in "${COFFEE}"/*/etc/crontab; do
        if [[ -r "$file" ]]; then
            echo "Found ${file} ..."
            crontabs+=( "$file" )
        fi
    done
    cat_cronfiles "${crontabs[@]}" | crontab - && echo "Installed new crontab"
    (( VERBOSE )) && echo

    (( VERBOSE )) && header "NEW CRONTAB"
    (( VERBOSE )) && crontab -l
}


function cat_cronfiles() {
    local file

    echo "##############################################################################"
    echo "# Generated by ${SCRIPTNAME} on $(date)"
    echo

    for file in "$@"; do
        echo "##############################################################################"
        echo "# ${file}"
        echo
        cat "$file"
        echo
    done
}


function header() {
    echo "******************************************************************************"
    echo "*** ${1} ***"
    echo
}


##############################################################################
# ENTRY POINT

main "$@"
